<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="David Garcia-Callejas and cxr team" />


<title>Using your own models</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Using your own models</h1>
<h4 class="author">David Garcia-Callejas and cxr team</h4>



<p>One of the design principles of <code>cxr</code> is to allow users to estimate parameters from their own models. <code>cxr</code> already includes four families of well-known population dynamic models: Beverton-Holt (BH), Lotka-Volterra (LV), Ricker (RK), and Law-Watkinson (LW), all in their discrete time formulation (see the accompanying publication of <code>cxr</code> for formulation of these general families). Users can choose between these default families by setting the <code>model_family</code> argument to the acronym of the chosen model. In this vignette we show, step by step, how other user-defined models can be integrated in the package.</p>
<p>First of all, a common feature of the families included is that they rely on a common set of parameters, namely <code>lambda</code>,<code>alpha</code> (separated in <code>alpha_intra</code> and <code>alpha_inter</code>), <code>lambda_cov</code>, and <code>alpha_cov</code>. For now, user-defined models within <code>cxr</code> must be restricted to these parameters. A detailed description of these parameters can be found in previous vignettes. This does not preclude users to hard-code other model parameters inside the model functions, and future releases will aim to relax this assumption.</p>
<p>At the end of this vignette we include the full R code of a model template that can be used directly into <code>cxr</code>. This template is also included as a stand-alone R file in the source files of the package (<code>cxr_model_template.R</code>), and here we first explain each section of it.</p>
<p>First, model functions should be defined with the common set of arguments recognized by <code>cxr</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">pm_family_alpha_form_lambdacov_form_alphacov_form &lt;-<span class="st"> </span><span class="cf">function</span>(par,</a>
<a class="sourceLine" id="cb1-2" title="2">                                                              fitness,</a>
<a class="sourceLine" id="cb1-3" title="3">                                                              <span class="dt">neigh_intra_matrix =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb1-4" title="4">                                                              neigh_inter_matrix,</a>
<a class="sourceLine" id="cb1-5" title="5">                                                              covariates,</a>
<a class="sourceLine" id="cb1-6" title="6">                                                              fixed_parameters)</a></code></pre></div>
<p>Assuming data for <span class="math inline">\(n\)</span> observations of a focal species and <span class="math inline">\(s\)</span> neighbour species (including itself), the function arguments are:</p>
<ul>
<li><em>par</em>: one-dimensional numeric vector including all parameters to fit.</li>
<li><em>fitness</em>: one-dimensional vector of length <span class="math inline">\(n\)</span> with fitness observations in log scale.</li>
<li><em>neigh_intra_matrix</em>: matrix of <span class="math inline">\(n\)</span> rows and 1 column, with observations of intraspecific neighbours.</li>
<li><em>neigh_inter_matrix</em>: matrix of <span class="math inline">\(n\)</span> rows and <span class="math inline">\(s-1\)</span> columns, with observations of interspecific neighbours.</li>
<li><em>covariates</em>: dataframe with <span class="math inline">\(n\)</span> rows and as many columns as covariates.</li>
<li><em>fixed_parameters</em>: list with values of parameters that are not to be fitted.</li>
</ul>
<p>the name of the function should be adapted to the parameters you want to fit:</p>
<ul>
<li><em>‘family’</em> is the two-letter acronym of your model family.</li>
<li><em>‘alpha_form’</em> is one of ‘alpha_none’,‘alpha_global’, or ‘alpha_pairwise’, depending on whether no alphas, a single alpha, or pairwise alphas are included in your model.</li>
<li><em>‘lambda_cov_form’</em> is one of ‘lambda_cov_none’ or ‘lambda_cov_global’, depending on whether you include the effect of covariates over lambda.</li>
<li><em>‘alpha_cov_form’</em> is one of ‘alpha_cov_none’, ‘alpha_cov_global’, or ‘alpha_cov_pairwise’, depending on whether and how to include the effect of covariates over alpha values: no inclusion, a global parameter for each covariate on the alpha values, or interaction-specific parameters for each covariate.</li>
</ul>
<p>Thus, if you code a model from your User Model (UM) family that includes pairwise alphas, but no effects of covariates over lambda or alpha, your function must be named as:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">pm_UM_alpha_pairwise_lambdacov_none_alphacov_none &lt;-<span class="st"> </span><span class="cf">function</span>(par,</a>
<a class="sourceLine" id="cb2-2" title="2">                                                              fitness,</a>
<a class="sourceLine" id="cb2-3" title="3">                                                              <span class="dt">neigh_intra_matrix =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb2-4" title="4">                                                              neigh_inter_matrix,</a>
<a class="sourceLine" id="cb2-5" title="5">                                                              covariates,</a>
<a class="sourceLine" id="cb2-6" title="6">                                                              fixed_parameters)</a></code></pre></div>
<p>The first step inside the function is to retrieve the different parameters from the one-dimensional <code>par</code> vector. You should not have to change this section except for commenting or commenting out the section where parameters are retrieved. For example, if your model does not include <code>lambda_cov</code> or <code>alpha_cov</code>, you should comment their sections. Note that it includes a final parameter, sigma, that should always be there, as it keeps track of the error associated to the fit.</p>
<p>This is how this part in your ‘pm_UM_alpha_pairwise_lambdacov_none_alphacov_none’ model would look like:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="co"># retrieve parameters -----------------------------------------------------</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="co"># parameters to fit are all in the &quot;par&quot; vector,</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="co"># so we need to retrieve them one by one</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co"># order is {lambda,lambda_cov,alpha,alpha_cov,sigma}</span></a>
<a class="sourceLine" id="cb3-5" title="5"></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co"># comment or uncomment sections for the different parameters</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co"># depending on whether your model includes them</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co"># note that the section on alpha_inter includes two</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co"># possibilities, depending on whether a single alpha is </span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co"># fitted for all interactions (global) or each pairwise alpha is </span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co"># different (pairwise)</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co"># both are commented, you need to uncomment the appropriate one</span></a>
<a class="sourceLine" id="cb3-13" title="13"></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="co"># likewise for the section on alpha_cov</span></a>
<a class="sourceLine" id="cb3-15" title="15"></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="co"># --------------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb3-17" title="17"></a>
<a class="sourceLine" id="cb3-18" title="18">pos &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-19" title="19"></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="co"># if a parameter is passed within the &quot;par&quot; vector,</span></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="co"># it should be NULL in the &quot;fixed_parameters&quot; list</span></a>
<a class="sourceLine" id="cb3-22" title="22"></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="co"># lambda</span></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters<span class="op">$</span>lambda)){</a>
<a class="sourceLine" id="cb3-25" title="25">  lambda &lt;-<span class="st"> </span>par[pos]</a>
<a class="sourceLine" id="cb3-26" title="26">  pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-27" title="27">}<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb3-28" title="28">  lambda &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;lambda&quot;</span>]]</a>
<a class="sourceLine" id="cb3-29" title="29">}</a>
<a class="sourceLine" id="cb3-30" title="30"></a>
<a class="sourceLine" id="cb3-31" title="31"><span class="co"># lambda_cov</span></a>
<a class="sourceLine" id="cb3-32" title="32"><span class="co"># if(is.null(fixed_parameters$lambda_cov)){</span></a>
<a class="sourceLine" id="cb3-33" title="33"><span class="co">#   lambda_cov &lt;- par[pos:(pos+ncol(covariates)-1)]</span></a>
<a class="sourceLine" id="cb3-34" title="34"><span class="co">#   pos &lt;- pos + ncol(covariates)</span></a>
<a class="sourceLine" id="cb3-35" title="35"><span class="co"># }else{</span></a>
<a class="sourceLine" id="cb3-36" title="36"><span class="co">#   lambda_cov &lt;- fixed_parameters[[&quot;lambda_cov&quot;]]</span></a>
<a class="sourceLine" id="cb3-37" title="37"><span class="co"># }</span></a>
<a class="sourceLine" id="cb3-38" title="38"></a>
<a class="sourceLine" id="cb3-39" title="39"><span class="co"># alpha_intra</span></a>
<a class="sourceLine" id="cb3-40" title="40"><span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(neigh_intra_matrix)){</a>
<a class="sourceLine" id="cb3-41" title="41">  <span class="co"># intra</span></a>
<a class="sourceLine" id="cb3-42" title="42">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters[[<span class="st">&quot;alpha_intra&quot;</span>]])){</a>
<a class="sourceLine" id="cb3-43" title="43">    alpha_intra &lt;-<span class="st"> </span>par[pos]</a>
<a class="sourceLine" id="cb3-44" title="44">    pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb3-45" title="45">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb3-46" title="46">    alpha_intra &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;alpha_intra&quot;</span>]]</a>
<a class="sourceLine" id="cb3-47" title="47">  }</a>
<a class="sourceLine" id="cb3-48" title="48">}<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb3-49" title="49">  alpha_intra &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb3-50" title="50">}</a>
<a class="sourceLine" id="cb3-51" title="51"></a>
<a class="sourceLine" id="cb3-52" title="52"><span class="co"># alpha_inter</span></a>
<a class="sourceLine" id="cb3-53" title="53"><span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters[[<span class="st">&quot;alpha_inter&quot;</span>]])){</a>
<a class="sourceLine" id="cb3-54" title="54">  <span class="co"># uncomment for alpha_global</span></a>
<a class="sourceLine" id="cb3-55" title="55">  <span class="co"># alpha_inter &lt;- par[pos]</span></a>
<a class="sourceLine" id="cb3-56" title="56">  <span class="co"># pos &lt;- pos + 1</span></a>
<a class="sourceLine" id="cb3-57" title="57">  </a>
<a class="sourceLine" id="cb3-58" title="58">  <span class="co"># uncomment for alpha_pairwise</span></a>
<a class="sourceLine" id="cb3-59" title="59">  alpha_inter &lt;-<span class="st"> </span>par[pos<span class="op">:</span>(pos<span class="op">+</span><span class="kw">ncol</span>(neigh_inter_matrix)<span class="op">-</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb3-60" title="60">  pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span><span class="kw">ncol</span>(neigh_inter_matrix)</a>
<a class="sourceLine" id="cb3-61" title="61">}<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb3-62" title="62">  alpha_inter &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;alpha_inter&quot;</span>]]</a>
<a class="sourceLine" id="cb3-63" title="63">}</a>
<a class="sourceLine" id="cb3-64" title="64"></a>
<a class="sourceLine" id="cb3-65" title="65"><span class="co"># alpha_cov</span></a>
<a class="sourceLine" id="cb3-66" title="66"><span class="co"># if(is.null(fixed_parameters$alpha_cov)){</span></a>
<a class="sourceLine" id="cb3-67" title="67"><span class="co">#   # uncomment for alpha_cov_global</span></a>
<a class="sourceLine" id="cb3-68" title="68"><span class="co">#   # alpha_cov &lt;- par[pos:(pos+ncol(covariates)-1)]</span></a>
<a class="sourceLine" id="cb3-69" title="69"><span class="co">#   # pos &lt;- pos + ncol(covariates)</span></a>
<a class="sourceLine" id="cb3-70" title="70"><span class="co">#   </span></a>
<a class="sourceLine" id="cb3-71" title="71"><span class="co">#   # uncomment for alpha_cov_pairwise</span></a>
<a class="sourceLine" id="cb3-72" title="72"><span class="co">#   # alpha_cov &lt;- par[pos:(pos+(ncol(covariates)*</span></a>
<a class="sourceLine" id="cb3-73" title="73"><span class="co">#   # (ncol(neigh_inter_matrix)+ncol(neigh_intra_matrix)))-1)]</span></a>
<a class="sourceLine" id="cb3-74" title="74"><span class="co">#   # pos &lt;- pos + (ncol(covariates)*(ncol(neigh_inter_matrix)+ncol(neigh_intra_matrix)))</span></a>
<a class="sourceLine" id="cb3-75" title="75"><span class="co"># }else{</span></a>
<a class="sourceLine" id="cb3-76" title="76"><span class="co">#   alpha_cov &lt;- fixed_parameters[[&quot;alpha_cov&quot;]]</span></a>
<a class="sourceLine" id="cb3-77" title="77"><span class="co"># }</span></a>
<a class="sourceLine" id="cb3-78" title="78"></a>
<a class="sourceLine" id="cb3-79" title="79"><span class="co"># sigma - this is always necessary</span></a>
<a class="sourceLine" id="cb3-80" title="80">sigma &lt;-<span class="st"> </span>par[<span class="kw">length</span>(par)]</a></code></pre></div>
<p>At this point, you can code your model. This is how the equivalent Beverton-Holt model looks like, for reference:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="co"># MODEL CODE HERE ---------------------------------------------------------</span></a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="co"># the model should return a &quot;pred&quot; value</span></a>
<a class="sourceLine" id="cb4-4" title="4"><span class="co"># a function of lambda, alpha_intra, alpha_inter, lambda_cov, alpha_cov </span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co"># and neigh_intra_matrix, neigh_inter_matrix, and covariates</span></a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co"># we do not differentiate alpha_intra from alpha_inter in this model</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="co"># so, put together alpha_intra and alpha_inter, and the observations</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co"># with intraspecific ones at the beginning</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(alpha_intra)){</a>
<a class="sourceLine" id="cb4-11" title="11">  alpha &lt;-<span class="st"> </span><span class="kw">c</span>(alpha_intra,alpha_inter)</a>
<a class="sourceLine" id="cb4-12" title="12">  all_neigh_matrix &lt;-<span class="st"> </span><span class="kw">cbind</span>(neigh_intra_matrix,neigh_inter_matrix)</a>
<a class="sourceLine" id="cb4-13" title="13">}<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb4-14" title="14">  alpha &lt;-<span class="st"> </span>alpha_inter</a>
<a class="sourceLine" id="cb4-15" title="15">  all_neigh_matrix &lt;-<span class="st"> </span>neigh_inter_matrix</a>
<a class="sourceLine" id="cb4-16" title="16">}</a>
<a class="sourceLine" id="cb4-17" title="17"></a>
<a class="sourceLine" id="cb4-18" title="18">term =<span class="st"> </span><span class="dv">1</span> <span class="co">#create the denominator term for the model</span></a>
<a class="sourceLine" id="cb4-19" title="19"><span class="cf">for</span>(z <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(all_neigh_matrix)){</a>
<a class="sourceLine" id="cb4-20" title="20">  term &lt;-<span class="st"> </span>term <span class="op">+</span><span class="st"> </span>alpha[z]<span class="op">*</span>all_neigh_matrix[,z] </a>
<a class="sourceLine" id="cb4-21" title="21">}</a>
<a class="sourceLine" id="cb4-22" title="22">pred &lt;-<span class="st"> </span>lambda<span class="op">/</span><span class="st"> </span>term</a>
<a class="sourceLine" id="cb4-23" title="23"></a>
<a class="sourceLine" id="cb4-24" title="24"><span class="co"># MODEL CODE ENDS HERE ----------------------------------------------------</span></a></code></pre></div>
<p>Note how there are no hard-coded checks for ensuring that alpha values and neigh_matrix values are appropriately sorted. This is performed in the <code>cxr_pm_fit</code> function that internally sorts data and call this model for optimization.</p>
<p>The last part of the model function is returning the negative log-likelihood value for that particular parameter combination. This is the value that the numerical optimization algorithms aim to minimize. You should not change this code.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># the routine returns the sum of negative log-likelihoods of the data and model:</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co"># DO NOT CHANGE THIS</span></a>
<a class="sourceLine" id="cb5-3" title="3">llik &lt;-<span class="st"> </span><span class="kw">dnorm</span>(fitness, <span class="dt">mean =</span> (<span class="kw">log</span>(pred)), <span class="dt">sd =</span> (sigma), <span class="dt">log=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">return</span>(<span class="kw">sum</span>(<span class="op">-</span><span class="dv">1</span><span class="op">*</span>llik))</a></code></pre></div>
<p>When you have a functioning model, you should be able to use it within <code>cxr</code> as soon as you load your model into the global environment, which can be done simply by ‘sourcing’ your R file named with the name of your model, i.e. ‘pm_UM_alpha_pairwise_lambdacov_none_alphacov_none.R’ in our example.</p>
<p>Thus, for fitting a certain dataset with your custom model, you would call the <code>cxr_pm_fit</code> function with the appropriate parameters:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># load your model into the global environment</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">source</span>(<span class="st">&quot;./pm_UM_alpha_pairwise_lambdacov_none_alphacov_none.R&quot;</span>)</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co"># fit your data</span></a>
<a class="sourceLine" id="cb6-4" title="4">custom_fit &lt;-<span class="st"> </span><span class="kw">cxr_pm_fit</span>(<span class="dt">data =</span> custom_data, <span class="co"># assuming custom_data is already set...</span></a>
<a class="sourceLine" id="cb6-5" title="5">                         <span class="dt">focal_column =</span> my_focal, <span class="co"># assuming my_focal is already set...</span></a>
<a class="sourceLine" id="cb6-6" title="6">                         <span class="dt">model_family =</span> <span class="st">&quot;UM&quot;</span>,</a>
<a class="sourceLine" id="cb6-7" title="7">                         <span class="dt">covariates =</span> <span class="ot">NULL</span>, <span class="co"># as we have no covariate effects</span></a>
<a class="sourceLine" id="cb6-8" title="8">                         <span class="dt">alpha_form =</span> <span class="st">&quot;pairwise&quot;</span>,</a>
<a class="sourceLine" id="cb6-9" title="9">                         <span class="dt">lambda_cov_form =</span> <span class="st">&quot;none&quot;</span>,</a>
<a class="sourceLine" id="cb6-10" title="10">                         <span class="dt">alpha_cov_form =</span> <span class="st">&quot;none&quot;</span>)</a></code></pre></div>
<p>If the function cannot find a model matching the provided ‘model_family’,‘alpha_form’,‘lambda_cov_form’, and ‘alpha_cov_form’, it will output a message and return NULL. On a final note, if you think your bright new model can be useful for fellow scientists, we encourage you to make a pull request for integrating it in the set of default model families included in <code>cxr</code>. An interesting update to the package would be, in addition to include other model families, to implement non-linear models of covariate effects over lambda and alpha values.</p>
<p>There are several issues that you should have in mind when developing custom models. First, recall that numerical optimization methods may be bounded or unbounded. If your model does not return meaningful values for part of the parameter space defined by the hypervolume of parameter boundaries, bounded optimization methods (such as ‘L-BFGS-B’ or ‘bobyqa’) will fail. This is well exemplified by the discrete Lotka-Volterra model:</p>
<p><span class="math inline">\(\lambda_i - \alpha_{ii}N_i - \alpha_{ij}Nj\)</span></p>
<p>which can easily produce negative values and thus undefined log-likelihoods. The second point to note is that user-defined population dynamics models are sufficient to obtain tailored lambda and alpha values, but importantly, several MCT metrics are also model-specific.</p>
<p><strong>Model-specific coexistence metrics</strong></p>
<p>Among the coexistence metrics that can be calculated with <code>cxr</code>, five of them are model-specific, i.e. have different formulations depending on the underlying population dynamics model from which lambda and alpha values are obtained. These are:</p>
<ul>
<li>demographic ratio (and therefore, average fitness differences in the MCT formulation)</li>
<li>competitive ability</li>
<li>competitive effects and responses</li>
<li>species fitness in the absence of niche differences</li>
</ul>
<p>All these have different formulations for different model families. Therefore, if you want to estimate coexistence metrics based on custom models, you should provide a full set of formulations for these metrics. Here we show their formulation for Beverton-Holt models, for reference. The supplementary material of Godoy and Levine (2014) and that of Hart et al. (2018) are good places to explore the mathematical underpinnings of these particularities.</p>
<ul>
<li>demographic ratio:</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">BH_demographic_ratio &lt;-<span class="st"> </span><span class="cf">function</span>(pair_lambdas){</a>
<a class="sourceLine" id="cb7-2" title="2">  (pair_lambdas[<span class="dv">1</span>]<span class="op">-</span><span class="dv">1</span>)<span class="op">/</span>(pair_lambdas[<span class="dv">2</span>]<span class="op">-</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-3" title="3">}</a></code></pre></div>
<ul>
<li>competitive ability:</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">BH_competitive_ability &lt;-<span class="st"> </span><span class="cf">function</span>(lambda, pair_matrix){</a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="cf">if</span>(<span class="kw">all</span>(pair_matrix <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>)){</a>
<a class="sourceLine" id="cb8-3" title="3">    (lambda <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)<span class="op">/</span><span class="kw">sqrt</span>(pair_matrix[<span class="dv">1</span>,<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>pair_matrix[<span class="dv">1</span>,<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb8-4" title="4">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb8-5" title="5">    <span class="ot">NA_real_</span></a>
<a class="sourceLine" id="cb8-6" title="6">  }</a>
<a class="sourceLine" id="cb8-7" title="7">}</a></code></pre></div>
<ul>
<li>competitive effects and responses: these are obtained with an optimization function <code>cxr_er_fit</code>, which is similar to <code>cxr_pm_fit</code> (see vignette 1). We include at the end of this vignette the complete model template for a custom effect and response model. The formulation of the Beverton-Holt effect and response model is simply</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">pred &lt;-<span class="st"> </span>lambda.part<span class="op">/</span><span class="st"> </span>(<span class="dv">1</span><span class="op">+</span><span class="st"> </span>e.part<span class="op">*</span>r.part )</a></code></pre></div>
<p>where each part potentially depends on neighbour densities and covariates.</p>
<ul>
<li>species fitness in the absence of niche differences:</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">BH_species_fitness &lt;-<span class="st"> </span><span class="cf">function</span>(lambda, competitive_response){</a>
<a class="sourceLine" id="cb10-2" title="2">  (lambda<span class="dv">-1</span>)<span class="op">/</span>competitive_response</a>
<a class="sourceLine" id="cb10-3" title="3">}</a></code></pre></div>
<p>Therefore, in order to compute coexistence metrics based on your custom population dynamics model, you should code your own versions of these metrics, save them with appropriate names (i.e. changing the model family acronym at the beginning of the functions), and source them in the global environment, in order for the <code>cxr</code> interface to be able to find and use them.</p>
<p><strong>Template for population dynamics models</strong></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">pm_family_alpha_form_lambdacov_form_alphacov_form &lt;-<span class="st"> </span><span class="cf">function</span>(par,</a>
<a class="sourceLine" id="cb11-2" title="2">                                                              fitness,</a>
<a class="sourceLine" id="cb11-3" title="3">                                                              <span class="dt">neigh_intra_matrix =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb11-4" title="4">                                                              neigh_inter_matrix,</a>
<a class="sourceLine" id="cb11-5" title="5">                                                              covariates,</a>
<a class="sourceLine" id="cb11-6" title="6">                                                              fixed_parameters){</a>
<a class="sourceLine" id="cb11-7" title="7">  </a>
<a class="sourceLine" id="cb11-8" title="8">  </a>
<a class="sourceLine" id="cb11-9" title="9">  <span class="co"># retrieve parameters -----------------------------------------------------</span></a>
<a class="sourceLine" id="cb11-10" title="10">  <span class="co"># parameters to fit are all in the &quot;par&quot; vector,</span></a>
<a class="sourceLine" id="cb11-11" title="11">  <span class="co"># so we need to retrieve them one by one</span></a>
<a class="sourceLine" id="cb11-12" title="12">  <span class="co"># order is {lambda,lambda_cov,alpha_intra,alpha_inter,alpha_cov,sigma}</span></a>
<a class="sourceLine" id="cb11-13" title="13">  </a>
<a class="sourceLine" id="cb11-14" title="14">  <span class="co"># comment or uncomment sections for the different parameters</span></a>
<a class="sourceLine" id="cb11-15" title="15">  <span class="co"># depending on whether your model includes them</span></a>
<a class="sourceLine" id="cb11-16" title="16">  <span class="co"># note that the section on alpha_inter includes two</span></a>
<a class="sourceLine" id="cb11-17" title="17">  <span class="co"># possibilities, depending on whether a single alpha is </span></a>
<a class="sourceLine" id="cb11-18" title="18">  <span class="co"># fitted for all interactions (global) or each pairwise alpha is </span></a>
<a class="sourceLine" id="cb11-19" title="19">  <span class="co"># different (pairwise)</span></a>
<a class="sourceLine" id="cb11-20" title="20">  <span class="co"># both are commented, you need to uncomment the appropriate one</span></a>
<a class="sourceLine" id="cb11-21" title="21">  </a>
<a class="sourceLine" id="cb11-22" title="22">  <span class="co"># likewise for the section on alpha_cov</span></a>
<a class="sourceLine" id="cb11-23" title="23">  </a>
<a class="sourceLine" id="cb11-24" title="24">  <span class="co"># --------------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb11-25" title="25">  </a>
<a class="sourceLine" id="cb11-26" title="26">  pos &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb11-27" title="27">  </a>
<a class="sourceLine" id="cb11-28" title="28">  <span class="co"># if a parameter is passed within the &quot;par&quot; vector,</span></a>
<a class="sourceLine" id="cb11-29" title="29">  <span class="co"># it should be NULL in the &quot;fixed_parameters&quot; list</span></a>
<a class="sourceLine" id="cb11-30" title="30">  </a>
<a class="sourceLine" id="cb11-31" title="31">  <span class="co"># lambda</span></a>
<a class="sourceLine" id="cb11-32" title="32">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters<span class="op">$</span>lambda)){</a>
<a class="sourceLine" id="cb11-33" title="33">    lambda &lt;-<span class="st"> </span>par[pos]</a>
<a class="sourceLine" id="cb11-34" title="34">    pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb11-35" title="35">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb11-36" title="36">    lambda &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;lambda&quot;</span>]]</a>
<a class="sourceLine" id="cb11-37" title="37">  }</a>
<a class="sourceLine" id="cb11-38" title="38">  </a>
<a class="sourceLine" id="cb11-39" title="39">  <span class="co"># lambda_cov</span></a>
<a class="sourceLine" id="cb11-40" title="40">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters<span class="op">$</span>lambda_cov)){</a>
<a class="sourceLine" id="cb11-41" title="41">    lambda_cov &lt;-<span class="st"> </span>par[pos<span class="op">:</span>(pos<span class="op">+</span><span class="kw">ncol</span>(covariates)<span class="op">-</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb11-42" title="42">    pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span><span class="kw">ncol</span>(covariates)</a>
<a class="sourceLine" id="cb11-43" title="43">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb11-44" title="44">    lambda_cov &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;lambda_cov&quot;</span>]]</a>
<a class="sourceLine" id="cb11-45" title="45">  }</a>
<a class="sourceLine" id="cb11-46" title="46">  </a>
<a class="sourceLine" id="cb11-47" title="47">  <span class="co"># alpha_intra</span></a>
<a class="sourceLine" id="cb11-48" title="48">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.null</span>(neigh_intra_matrix)){</a>
<a class="sourceLine" id="cb11-49" title="49">    <span class="co"># intra</span></a>
<a class="sourceLine" id="cb11-50" title="50">    <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters[[<span class="st">&quot;alpha_intra&quot;</span>]])){</a>
<a class="sourceLine" id="cb11-51" title="51">      alpha_intra &lt;-<span class="st"> </span>par[pos]</a>
<a class="sourceLine" id="cb11-52" title="52">      pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb11-53" title="53">    }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb11-54" title="54">      alpha_intra &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;alpha_intra&quot;</span>]]</a>
<a class="sourceLine" id="cb11-55" title="55">    }</a>
<a class="sourceLine" id="cb11-56" title="56">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb11-57" title="57">    alpha_intra &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb11-58" title="58">  }</a>
<a class="sourceLine" id="cb11-59" title="59">  </a>
<a class="sourceLine" id="cb11-60" title="60">  <span class="co"># alpha_inter</span></a>
<a class="sourceLine" id="cb11-61" title="61">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters[[<span class="st">&quot;alpha_inter&quot;</span>]])){</a>
<a class="sourceLine" id="cb11-62" title="62">    <span class="co"># uncomment for alpha_global</span></a>
<a class="sourceLine" id="cb11-63" title="63">    <span class="co"># alpha_inter &lt;- par[pos]</span></a>
<a class="sourceLine" id="cb11-64" title="64">    <span class="co"># pos &lt;- pos + 1</span></a>
<a class="sourceLine" id="cb11-65" title="65">    </a>
<a class="sourceLine" id="cb11-66" title="66">    <span class="co"># uncomment for alpha_pairwise</span></a>
<a class="sourceLine" id="cb11-67" title="67">    <span class="co"># alpha_inter &lt;- par[pos:(pos+ncol(neigh_inter_matrix)-1)]</span></a>
<a class="sourceLine" id="cb11-68" title="68">    <span class="co"># pos &lt;- pos + ncol(neigh_inter_matrix)</span></a>
<a class="sourceLine" id="cb11-69" title="69">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb11-70" title="70">    alpha_inter &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;alpha_inter&quot;</span>]]</a>
<a class="sourceLine" id="cb11-71" title="71">  }</a>
<a class="sourceLine" id="cb11-72" title="72">  </a>
<a class="sourceLine" id="cb11-73" title="73">  <span class="co"># alpha_cov</span></a>
<a class="sourceLine" id="cb11-74" title="74">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters<span class="op">$</span>alpha_cov)){</a>
<a class="sourceLine" id="cb11-75" title="75">    <span class="co"># uncomment for alpha_cov_global</span></a>
<a class="sourceLine" id="cb11-76" title="76">    <span class="co"># alpha_cov &lt;- par[pos:(pos+ncol(covariates)-1)]</span></a>
<a class="sourceLine" id="cb11-77" title="77">    <span class="co"># pos &lt;- pos + ncol(covariates)</span></a>
<a class="sourceLine" id="cb11-78" title="78">    </a>
<a class="sourceLine" id="cb11-79" title="79">    <span class="co"># uncomment for alpha_cov_pairwise</span></a>
<a class="sourceLine" id="cb11-80" title="80">    <span class="co"># alpha_cov &lt;- par[pos:(pos+(ncol(covariates)*</span></a>
<a class="sourceLine" id="cb11-81" title="81">    <span class="co"># (ncol(neigh_inter_matrix)+ncol(neigh_intra_matrix)))-1)]</span></a>
<a class="sourceLine" id="cb11-82" title="82">    <span class="co"># pos &lt;- pos + (ncol(covariates)*(ncol(neigh_inter_matrix)+ncol(neigh_intra_matrix)))</span></a>
<a class="sourceLine" id="cb11-83" title="83">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb11-84" title="84">    alpha_cov &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;alpha_cov&quot;</span>]]</a>
<a class="sourceLine" id="cb11-85" title="85">  }</a>
<a class="sourceLine" id="cb11-86" title="86">  </a>
<a class="sourceLine" id="cb11-87" title="87">  <span class="co"># sigma - this is always necessary</span></a>
<a class="sourceLine" id="cb11-88" title="88">  sigma &lt;-<span class="st"> </span>par[<span class="kw">length</span>(par)]</a>
<a class="sourceLine" id="cb11-89" title="89">  </a>
<a class="sourceLine" id="cb11-90" title="90">  <span class="co"># now, parameters have appropriate values (or NULL)</span></a>
<a class="sourceLine" id="cb11-91" title="91">  <span class="co"># next section is where your model is coded</span></a>
<a class="sourceLine" id="cb11-92" title="92">  </a>
<a class="sourceLine" id="cb11-93" title="93">  <span class="co"># MODEL CODE HERE ---------------------------------------------------------</span></a>
<a class="sourceLine" id="cb11-94" title="94">  </a>
<a class="sourceLine" id="cb11-95" title="95">  <span class="co"># the model should return a &quot;pred&quot; value</span></a>
<a class="sourceLine" id="cb11-96" title="96">  <span class="co"># a function of lambda, alpha_intra, alpha_inter, lambda_cov, alpha_cov </span></a>
<a class="sourceLine" id="cb11-97" title="97">  <span class="co"># and neigh_intra_matrix, neigh_inter_matrix, and covariates</span></a>
<a class="sourceLine" id="cb11-98" title="98">  pred &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb11-99" title="99">  </a>
<a class="sourceLine" id="cb11-100" title="100">  <span class="co"># MODEL CODE ENDS HERE ----------------------------------------------------</span></a>
<a class="sourceLine" id="cb11-101" title="101">  </a>
<a class="sourceLine" id="cb11-102" title="102">  <span class="co"># the routine returns the sum of log-likelihoods of the data and model:</span></a>
<a class="sourceLine" id="cb11-103" title="103">  <span class="co"># DO NOT CHANGE THIS</span></a>
<a class="sourceLine" id="cb11-104" title="104">  llik &lt;-<span class="st"> </span><span class="kw">dnorm</span>(fitness, <span class="dt">mean =</span> (<span class="kw">log</span>(pred)), <span class="dt">sd =</span> (sigma), <span class="dt">log=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-105" title="105">  <span class="kw">return</span>(<span class="kw">sum</span>(<span class="op">-</span><span class="dv">1</span><span class="op">*</span>llik))</a>
<a class="sourceLine" id="cb11-106" title="106">}</a></code></pre></div>
<p><strong>Template for effect and response models</strong></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">er_family_lambdacov_form_effectcov_form_responsecov_form &lt;-<span class="st"> </span><span class="cf">function</span>(par,</a>
<a class="sourceLine" id="cb12-2" title="2">                                                                     fitness,</a>
<a class="sourceLine" id="cb12-3" title="3">                                                                     target,</a>
<a class="sourceLine" id="cb12-4" title="4">                                                                     density,</a>
<a class="sourceLine" id="cb12-5" title="5">                                                                     covariates,</a>
<a class="sourceLine" id="cb12-6" title="6">                                                                     fixed_parameters){</a>
<a class="sourceLine" id="cb12-7" title="7">  </a>
<a class="sourceLine" id="cb12-8" title="8">  num.sp &lt;-<span class="st"> </span><span class="kw">nrow</span>(target)</a>
<a class="sourceLine" id="cb12-9" title="9">  </a>
<a class="sourceLine" id="cb12-10" title="10">  <span class="co"># parameters to fit are all in the &quot;par&quot; vector,</span></a>
<a class="sourceLine" id="cb12-11" title="11">  <span class="co"># so we need to retrieve them one by one</span></a>
<a class="sourceLine" id="cb12-12" title="12">  <span class="co"># order is {lambda,lambda_cov,effect,effect_cov,response,response_cov,sigma}</span></a>
<a class="sourceLine" id="cb12-13" title="13">  </a>
<a class="sourceLine" id="cb12-14" title="14">  <span class="co"># comment or uncomment sections for the different parameters</span></a>
<a class="sourceLine" id="cb12-15" title="15">  <span class="co"># depending on whether your model includes them</span></a>
<a class="sourceLine" id="cb12-16" title="16">  <span class="co"># note that effect and response models must always include</span></a>
<a class="sourceLine" id="cb12-17" title="17">  <span class="co"># lambda, effect, and response, at least.</span></a>
<a class="sourceLine" id="cb12-18" title="18">  </a>
<a class="sourceLine" id="cb12-19" title="19">  pos &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb12-20" title="20">  </a>
<a class="sourceLine" id="cb12-21" title="21">  <span class="co"># if a parameter is passed within the &quot;par&quot; vector,</span></a>
<a class="sourceLine" id="cb12-22" title="22">  <span class="co"># it should be NULL in the &quot;fixed_parameters&quot; list</span></a>
<a class="sourceLine" id="cb12-23" title="23">  </a>
<a class="sourceLine" id="cb12-24" title="24">  <span class="co"># lambda</span></a>
<a class="sourceLine" id="cb12-25" title="25">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters[[<span class="st">&quot;lambda&quot;</span>]])){</a>
<a class="sourceLine" id="cb12-26" title="26">    lambda &lt;-<span class="st"> </span>par[pos<span class="op">:</span>(pos <span class="op">+</span><span class="st"> </span>num.sp <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb12-27" title="27">    pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span>num.sp</a>
<a class="sourceLine" id="cb12-28" title="28">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb12-29" title="29">    lambda &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;lambda&quot;</span>]]</a>
<a class="sourceLine" id="cb12-30" title="30">  }</a>
<a class="sourceLine" id="cb12-31" title="31">  </a>
<a class="sourceLine" id="cb12-32" title="32">  <span class="co"># lambda_cov</span></a>
<a class="sourceLine" id="cb12-33" title="33">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters<span class="op">$</span>lambda_cov)){</a>
<a class="sourceLine" id="cb12-34" title="34">    <span class="co"># the covariate effects are more efficient in a matrix form</span></a>
<a class="sourceLine" id="cb12-35" title="35">    <span class="co"># with species in rows (hence byrow = T, because by default</span></a>
<a class="sourceLine" id="cb12-36" title="36">    <span class="co"># the vector is sorted first by covariates)</span></a>
<a class="sourceLine" id="cb12-37" title="37">    lambda_cov &lt;-<span class="st"> </span><span class="kw">matrix</span>(par[pos<span class="op">:</span>(pos<span class="op">+</span>(<span class="kw">ncol</span>(covariates)<span class="op">*</span>num.sp)<span class="op">-</span><span class="dv">1</span>)],</a>
<a class="sourceLine" id="cb12-38" title="38">                         <span class="dt">nrow =</span> num.sp,</a>
<a class="sourceLine" id="cb12-39" title="39">                         <span class="dt">byrow =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-40" title="40">    pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span><span class="kw">ncol</span>(covariates)<span class="op">*</span>num.sp</a>
<a class="sourceLine" id="cb12-41" title="41">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb12-42" title="42">    lambda_cov &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;lambda_cov&quot;</span>]]</a>
<a class="sourceLine" id="cb12-43" title="43">  }</a>
<a class="sourceLine" id="cb12-44" title="44">  </a>
<a class="sourceLine" id="cb12-45" title="45">  <span class="co"># effect</span></a>
<a class="sourceLine" id="cb12-46" title="46">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters[[<span class="st">&quot;effect&quot;</span>]])){</a>
<a class="sourceLine" id="cb12-47" title="47">    effect &lt;-<span class="st"> </span>par[pos<span class="op">:</span>(pos <span class="op">+</span><span class="st"> </span>num.sp <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb12-48" title="48">    pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span>num.sp</a>
<a class="sourceLine" id="cb12-49" title="49">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb12-50" title="50">    effect &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;effect&quot;</span>]]</a>
<a class="sourceLine" id="cb12-51" title="51">  }</a>
<a class="sourceLine" id="cb12-52" title="52">  </a>
<a class="sourceLine" id="cb12-53" title="53">  <span class="co"># effect_cov</span></a>
<a class="sourceLine" id="cb12-54" title="54">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters<span class="op">$</span>effect_cov)){</a>
<a class="sourceLine" id="cb12-55" title="55">    effect_cov &lt;-<span class="st"> </span><span class="kw">matrix</span>(par[pos<span class="op">:</span>(pos<span class="op">+</span>(<span class="kw">ncol</span>(covariates)<span class="op">*</span>num.sp)<span class="op">-</span><span class="dv">1</span>)],</a>
<a class="sourceLine" id="cb12-56" title="56">                         <span class="dt">nrow =</span> num.sp,</a>
<a class="sourceLine" id="cb12-57" title="57">                         <span class="dt">byrow =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-58" title="58">    pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span><span class="kw">ncol</span>(covariates)<span class="op">*</span>num.sp</a>
<a class="sourceLine" id="cb12-59" title="59">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb12-60" title="60">    effect_cov &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;effect_cov&quot;</span>]]</a>
<a class="sourceLine" id="cb12-61" title="61">  }</a>
<a class="sourceLine" id="cb12-62" title="62">  </a>
<a class="sourceLine" id="cb12-63" title="63">  <span class="co"># response</span></a>
<a class="sourceLine" id="cb12-64" title="64">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters[[<span class="st">&quot;response&quot;</span>]])){</a>
<a class="sourceLine" id="cb12-65" title="65">    response &lt;-<span class="st"> </span>par[pos<span class="op">:</span>(pos <span class="op">+</span><span class="st"> </span>num.sp <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb12-66" title="66">    pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span>num.sp</a>
<a class="sourceLine" id="cb12-67" title="67">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb12-68" title="68">    response &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;response&quot;</span>]]</a>
<a class="sourceLine" id="cb12-69" title="69">  }</a>
<a class="sourceLine" id="cb12-70" title="70">  </a>
<a class="sourceLine" id="cb12-71" title="71">  <span class="co"># response_cov</span></a>
<a class="sourceLine" id="cb12-72" title="72">  <span class="cf">if</span>(<span class="kw">is.null</span>(fixed_parameters[[<span class="st">&quot;response_cov&quot;</span>]])){</a>
<a class="sourceLine" id="cb12-73" title="73">    response_cov &lt;-<span class="st"> </span><span class="kw">matrix</span>(par[pos<span class="op">:</span>(pos<span class="op">+</span>(<span class="kw">ncol</span>(covariates)<span class="op">*</span>num.sp)<span class="op">-</span><span class="dv">1</span>)],</a>
<a class="sourceLine" id="cb12-74" title="74">                           <span class="dt">nrow =</span> num.sp,</a>
<a class="sourceLine" id="cb12-75" title="75">                           <span class="dt">byrow =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-76" title="76">    pos &lt;-<span class="st"> </span>pos <span class="op">+</span><span class="st"> </span><span class="kw">ncol</span>(covariates)<span class="op">*</span>num.sp</a>
<a class="sourceLine" id="cb12-77" title="77">  }<span class="cf">else</span>{</a>
<a class="sourceLine" id="cb12-78" title="78">    response_cov &lt;-<span class="st"> </span>fixed_parameters[[<span class="st">&quot;response_cov&quot;</span>]]</a>
<a class="sourceLine" id="cb12-79" title="79">  }</a>
<a class="sourceLine" id="cb12-80" title="80">  </a>
<a class="sourceLine" id="cb12-81" title="81">  sigma &lt;-<span class="st"> </span>par[<span class="kw">length</span>(par)]</a>
<a class="sourceLine" id="cb12-82" title="82">  </a>
<a class="sourceLine" id="cb12-83" title="83">  <span class="co"># now, parameters have appropriate values (or NULL)</span></a>
<a class="sourceLine" id="cb12-84" title="84">  <span class="co"># next section is where your model is coded</span></a>
<a class="sourceLine" id="cb12-85" title="85">  </a>
<a class="sourceLine" id="cb12-86" title="86">  <span class="co"># MODEL CODE HERE ---------------------------------------------------------</span></a>
<a class="sourceLine" id="cb12-87" title="87">  </a>
<a class="sourceLine" id="cb12-88" title="88">  <span class="co"># the model should return a &quot;pred&quot; value</span></a>
<a class="sourceLine" id="cb12-89" title="89">  <span class="co"># a function of lambda, effect, response, lambda_cov, effect_cov, response_cov</span></a>
<a class="sourceLine" id="cb12-90" title="90">  pred &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb12-91" title="91">  </a>
<a class="sourceLine" id="cb12-92" title="92">  <span class="co"># MODEL CODE ENDS HERE ----------------------------------------------------</span></a>
<a class="sourceLine" id="cb12-93" title="93">  </a>
<a class="sourceLine" id="cb12-94" title="94">  <span class="co"># the routine returns the sum of log-likelihoods of the data and model:</span></a>
<a class="sourceLine" id="cb12-95" title="95">  <span class="co"># DO NOT CHANGE THIS</span></a>
<a class="sourceLine" id="cb12-96" title="96">  llik &lt;-<span class="st"> </span><span class="kw">dnorm</span>(fitness, <span class="dt">mean =</span> (<span class="kw">log</span>(pred)), <span class="dt">sd =</span> (sigma), <span class="dt">log=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-97" title="97">  <span class="kw">return</span>(<span class="kw">sum</span>(<span class="op">-</span><span class="dv">1</span><span class="op">*</span>llik))</a>
<a class="sourceLine" id="cb12-98" title="98">  </a>
<a class="sourceLine" id="cb12-99" title="99">}</a></code></pre></div>
<p><strong>References</strong></p>
<p>Godoy, O., &amp; Levine, J. M. (2014). Phenology effects on invasion success: insights from coupling field experiments to coexistence theory. Ecology, 95(3), 726-736.</p>
<p>Hart, S. P., Freckleton, R. P., &amp; Levine, J. M. (2018). How to quantify competitive ability. Journal of Ecology, 106(5), 1902-1909.</p>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
