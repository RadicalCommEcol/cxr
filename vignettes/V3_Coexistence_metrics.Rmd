---
title: "Niche overlap and fitness differences"
output: rmarkdown::html_vignette
author: David García-Callejas and cxr team
vignette: >
  %\VignetteIndexEntry{coexistence metrics}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
#note - we disable warnings and other output for the vignette, otherwise the functions are quite "chatty". 
```

1 - Calculate niche overlap among a series of species

1.1 - Create a series of objects with the initial parameters.

```{r}
library(cxr)
data("neigh_list")
data <- neigh_list
# keep only fitness and neighbours columns
for(i in 1:length(data)){
  data[[i]] <- data[[i]][,2:length(data[[i]])]
}

focal_column <- names(data)
model_family <- "BH" 
optimization_method <- "nlminb" #AGAIN; WHY? MAKE A DEFAULT?
alpha_form <- "pairwise"
lambda_cov_form <- "none"
alpha_cov_form <- "none"
initial_values = list(lambda = 1,
                      alpha_intra = 0.1,
                      alpha_inter = 0.1)
lower_bounds = list(lambda = 0,
                    alpha_intra = 0.01,
                    alpha_inter = 0.01)
upper_bounds = list(lambda = 100,
                    alpha_intra = 1,
                    alpha_inter = 1)
fixed_terms <- NULL
bootstrap_samples <- 0
```

1.2 - Obtain lambda (seed production in the absence of interactions) and alpha (interaction coefficients) values.

```{r}
all.sp.fit <- cxr_pm_multifit(data = data,
                              model_family = model_family,
                              focal_column = focal_column,
                              optimization_method = optimization_method,
                              alpha_form = alpha_form,
                              lambda_cov_form = lambda_cov_form,
                              alpha_cov_form = alpha_cov_form,
                              initial_values = initial_values,
                              lower_bounds = lower_bounds,
                              upper_bounds = upper_bounds,
                              fixed_terms = fixed_terms,
                              bootstrap_samples = bootstrap_samples)

```

IB: LOS WARINGS SON FEOS PARA UNA VIGNETTE....

1.3 - Calculate niche overlap following Chesson (2000) [REF] and Saavedra et al. [REF]. This second one is specially suitable for when alpha prameters are positive (i.e. facilitation), as Chesson formulation can't handle such situations.

```{r}
niche_overlap_all_pairs <- niche_overlap(cxr_multifit = all.sp.fit)
head(niche_overlap_all_pairs)
```

2 - Calculate competitive ability of a series of species. ESTO NECESITA MÄS EXPLANATION... REF a GODOY al menos.

2.1 - Set initial parameters

```{r}
data("neigh_list")
# For culating effect and responses, all species need to have the same number of observations, hence we selct only 3 species that have >250 observations
example_sp <- c(1,4,5) #corresponding to BEMA, HOMA, LEMA
n.obs <- 250
data <- neigh_list[example_sp]
optimization_method <- "nlminb"
fixed_terms <- NULL
model_family <- "BH"
bootstrap_samples <- 0
# keep only fitness and neighbours columns
for(i in 1:length(data)){
  data[[i]] <- data[[i]][1:n.obs,c(2,example_sp+2)]#2:length(data[[i]])]
}
initial_values_er = list(lambda = 1, 
                         effect = 1, 
                         response = 1)
lower_bounds_er = list(lambda = 0, 
                       effect = 0, 
                       response = 0)
upper_bounds_er = list(lambda = 100, 
                       effect = 10, 
                       response = 10)
```

2.2 - calculate competitive response and effect of all species. Again, ref to Godoy 2014.

```{r}
er.fit <- cxr_er_fit(data = data,
                          model_family = model_family,
                          optimization_method = optimization_method,
                          initial_values = initial_values_er,
                          lower_bounds = lower_bounds_er,
                          upper_bounds = upper_bounds_er,
                          fixed_terms = fixed_terms,
                          bootstrap_samples = bootstrap_samples)
```

2.2 - fitness of all species fitted. Notice the Inf of BEMA, because the model fitted effect = response = 0. PICK A BETTER EXAMPLE THAT WORKS:

```{r}
spfitness <- species_fitness(er.fit)
spfitness
```

2.3 - fitness ratios among all species pairs

```{r}
fitness_ratios <- fitness_ratio(er.fit)
fitness_ratios
```

