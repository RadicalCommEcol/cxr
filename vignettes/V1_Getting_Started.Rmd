---
title: "Getting started with cxr"
output: rmarkdown::html_vignette
author: cxr team
vignette: >
  %\VignetteIndexEntry{Getting started}
  \usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

**Introduction**

The `cxr` package provides a general interface to obtain estimates of species vital rates and interaction coefficients between species pairs from empirical data. These estimations are critical to parameterize population models describing the dynamics of interacting species. They also allow computing a series of metrics associated with modern coexistence theory that inform about the likelihood of species to coexist. These metrics are the niche differences that stabilize coexistence between competing species and the average fitness differences that drive competitive dominance and in the absence of niche differences determine the superior competitor. The package also allow computing the two components of the average fitness differences. These are the demographic differences (i.e. species differences in their intrisic population growth rate) and competitive response differences (i.e. species differences in their sensitivity to reduce offspring in response to both intraspecific and interspecific competition). These two components are equally important for determining the species competitive ability (see *Hart et al. 2018 Journal of Ecology)

The package also allow exploring how environmental variation modifies both the ability of species to produce offspring and interaction coefficients between pairs of species (including itself). This feature open the possibility to explore how stabilizing niche differences and average fitness differences vary across environmental gradients, and therefore, it predicts whether the likelihood of species to coexist is not constant across environmental conditions.  

Here we demonstrate the basic functionality of the package using a published dataset (see *Lanuza, Bartomeus, Godoy. 2018. Ecology Letters 21:865-874* for a description of the dataset). With this example, we will specifically estimate from an observational species seed production in the absence of neighbors and the strength and sign of interactions between species pairs. These values are the basis for estimating the degree of niche overlap (i.e 1- niche differences) and average fitness differences between species pairs.  

**Set up**

First, we load the package and the associated data

```{r}
library(cxr)
data("neigh_list", package = "cxr")
```

1 - single species fit

```{r}
my.sp <- "HOMA"
# get data from the list
obs_homa <- neigh_list[[my.sp]]
# no need for ID column
obs_homa <- subset(obs_homa,select = -c(obs_ID))
```

```{r}
fit_homa <- cxr_pm_fit(data = obs_homa,
                       focal_column = my.sp,
                       model_family = "BH",
                       covariates = NULL,
                       optimization_method = "bobyqa",
                       alpha_form = "pairwise",
                       lambda_cov_form = "none",
                       alpha_cov_form = "none",
                       initial_values = list(lambda = 1,
                                             alpha_intra = .1,
                                             alpha_inter = .1),
                       lower_bounds = list(lambda = 0,
                                           alpha_intra = 0,
                                           alpha_inter = 0),
                       upper_bounds = list(lambda = 100,
                                           alpha_intra = 1,
                                           alpha_inter = 1),
                       fixed_terms = NULL,
                       bootstrap_samples = 3)
```

```{r}
summary(fit_homa)
```

we can access the elements of the returned object as usual

```{r}
# intraspecific interaction
fit_homa$alpha_intra
# interspecific interactions
fit_homa$alpha_inter
```

2 - multispecies fit including the effect of a covariate over lambda and alpha parameters

```{r}
my.sp <- c("BEMA","MEEL","PUPA")
obs_3sp <- data <- neigh_list[my.sp]
# discard ID column
for(i in 1:length(data)){
  obs_3sp[[i]] <- obs_3sp[[i]][,2:length(data[[i]])]
}
# covariates: salinity
data("salinity_list")
salinity <- salinity_list[my.sp]
# keep only salinity column
for(i in 1:length(salinity)){
  salinity[[i]] <- as.matrix(salinity[[i]][,2:length(salinity[[i]])])
  colnames(salinity[[i]]) <- "salinity"
}
```

```{r}
fit_3sp <- cxr_pm_multifit(data = obs_3sp,
                           focal_column = my.sp,
                           optimization_method = "bobyqa",
                           covariates = salinity,
                           alpha_form = "pairwise",
                           lambda_cov_form = "global",
                           alpha_cov_form = "global",
                           initial_values = list(lambda = 1,
                                                 alpha_intra = 0.1,
                                                 alpha_inter = 0.1,
                                                 lambda_cov = 0.1,
                                                 alpha_cov = 0.1),
                           lower_bounds = list(lambda = 0,
                                               alpha_intra = 0,
                                               alpha_inter = -1,
                                               lambda_cov = 0,
                                               alpha_cov = 0),
                           upper_bounds = list(lambda = 100,
                                               alpha_intra = 1,
                                               alpha_inter = 1,
                                               lambda_cov = 1,
                                               alpha_cov = 1),
                           bootstrap_samples = 3)
```

```{r}
summary(fit_3sp)
```









